# =============================================================================
# game_manager.py - ã‚²ãƒ¼ãƒ å…¨ä½“ã®ç®¡ç†
# =============================================================================
#
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã€ã‚²ãƒ¼ãƒ å…¨ä½“ã®æµã‚Œã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚
#
# ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§å­¦ã¹ã‚‹ã“ã¨ã€‘
# - ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®è¨­è¨ˆ
# - çŠ¶æ…‹é·ç§»ã®ç®¡ç†
# - è¤‡æ•°ã®ã‚¯ãƒ©ã‚¹ã‚’é€£æºã•ã›ã‚‹æ–¹æ³•
#
# =============================================================================

import random

# åŒã˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å†…ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from game.character import Player, create_random_enemy
from game.card import create_starting_deck
from game.battle import Battle


# =============================================================================
# GameState - ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’è¡¨ã™å®šæ•°ã‚¯ãƒ©ã‚¹
# =============================================================================
class GameState:
    """
    ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’è¡¨ã™å®šæ•°ã‚’å®šç¾©ã™ã‚‹ã‚¯ãƒ©ã‚¹ã§ã™ã€‚
    
    ã€è§£èª¬ã€‘
    ã‚²ãƒ¼ãƒ ã¯è¤‡æ•°ã®ã€ŒçŠ¶æ…‹ã€ã‚’æŒã¡ã€ãã‚Œãã‚Œã®çŠ¶æ…‹ã§ç•°ãªã‚‹å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚
    ã“ã®è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã€Œã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ï¼ˆçŠ¶æ…‹æ©Ÿæ¢°ï¼‰ã€ã¨å‘¼ã³ã¾ã™ã€‚
    
    ã€å„çŠ¶æ…‹ã®èª¬æ˜ã€‘
    - TITLE: ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢
    - MAP: ãƒãƒƒãƒ—é¸æŠç”»é¢ï¼ˆã©ã“ã«é€²ã‚€ã‹é¸ã¶ï¼‰
    - BATTLE: ãƒãƒˆãƒ«ä¸­
    - SHOP: ã‚·ãƒ§ãƒƒãƒ—ç”»é¢
    - EVENT: ã‚¤ãƒ™ãƒ³ãƒˆç”»é¢
    - GAME_OVER: ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢
    - VICTORY: ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ç”»é¢
    """
    TITLE = "title"
    MAP = "map"
    BATTLE = "battle"
    SHOP = "shop"
    EVENT = "event"
    GAME_OVER = "game_over"
    VICTORY = "victory"


# =============================================================================
# GameManager - ã‚²ãƒ¼ãƒ å…¨ä½“ã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹
# =============================================================================
class GameManager:
    """
    ã‚²ãƒ¼ãƒ å…¨ä½“ã®æµã‚Œã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹ã§ã™ã€‚
    
    ã€è§£èª¬ã€‘
    ã“ã®ã‚¯ãƒ©ã‚¹ã¯ã€Œã‚²ãƒ¼ãƒ ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã€ã¾ãŸã¯ã€Œã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã€ã¨å‘¼ã°ã‚Œã€
    ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ç®¡ç†ã€ç”»é¢é·ç§»ã€ãƒ‡ãƒ¼ã‚¿ã®ä¿æŒãªã©ã‚’æ‹…å½“ã—ã¾ã™ã€‚
    
    ã€è²¬ä»»ç¯„å›²ã€‘
    - ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®ç®¡ç†
    - ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†
    - ç”»é¢é·ç§»ã®åˆ¶å¾¡
    - ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®å®Ÿè¡Œ
    """
    
    def __init__(self):
        """
        ã‚²ãƒ¼ãƒ ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        ã‚²ãƒ¼ãƒ ã«å¿…è¦ãªå¤‰æ•°ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚
        å®Ÿéš›ã®ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«æ”¹ã‚ã¦åˆæœŸåŒ–ã•ã‚Œã‚‹å¤‰æ•°ã‚‚ã‚ã‚Šã¾ã™ã€‚
        """
        # ç¾åœ¨ã®ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        self.state = GameState.TITLE
        
        # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        # ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«ä½œæˆã•ã‚Œã¾ã™
        self.player = None
        
        # ç¾åœ¨ã®éšå±¤ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ç•ªå·ï¼‰
        # ãƒ­ãƒ¼ã‚°ãƒ©ã‚¤ã‚¯ç³»ã§ã¯éšå±¤ã‚’é€²ã‚€ã”ã¨ã«é›£æ˜“åº¦ãŒä¸ŠãŒã‚Šã¾ã™
        self.floor = 0
        
        # æœ€å¤§éšå±¤ï¼ˆã“ã‚Œã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼‰
        self.max_floor = 5
        
        # å€’ã—ãŸæ•µã®æ•°
        self.enemies_defeated = 0
        
        # ã‚²ãƒ¼ãƒ ãŒå®Ÿè¡Œä¸­ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
        self.running = False
    
    def start_new_game(self):
        """
        æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        1. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆ
        2. åˆæœŸãƒ‡ãƒƒã‚­ã‚’è¨­å®š
        3. éšå±¤ã‚’åˆæœŸåŒ–
        4. ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’å¤‰æ›´
        """
        print("\nğŸŒŸ æ–°ã—ã„å†’é™ºã‚’é–‹å§‹ã—ã¾ã™ï¼ ğŸŒŸ")
        
        # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åå‰ã‚’å…¥åŠ›
        name = input("å†’é™ºè€…ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„: ").strip()
        if not name:
            name = "å†’é™ºè€…"  # ç©ºã®å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        
        # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆ
        self.player = Player(name)
        
        # åˆæœŸãƒ‡ãƒƒã‚­ã‚’è¨­å®š
        self.player.deck = create_starting_deck()
        
        # éšå±¤ã¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
        self.floor = 1
        self.enemies_defeated = 0
        
        # çŠ¶æ…‹ã‚’ãƒãƒƒãƒ—ç”»é¢ã«å¤‰æ›´
        self.state = GameState.MAP
        
        print(f"\n{self.player.name}ã¯å†’é™ºã«å‡ºç™ºã—ãŸï¼")
        print(f"ç›®æ¨™: {self.max_floor}éšå±¤ã®ãƒœã‚¹ã‚’å€’ã™ã“ã¨")
    
    def display_title(self):
        """
        ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        ã‚²ãƒ¼ãƒ ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨é¸æŠè‚¢ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
        """
        print("\n" + "=" * 60)
        print("    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
        print("    â•‘  ãƒ­ãƒ¼ã‚°ãƒ©ã‚¤ã‚¯ãƒ»ã‚«ãƒ¼ãƒ‰ãƒãƒˆãƒ«  â•‘")
        print("    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
        print("=" * 60)
        print("\n    ã‚¿ãƒ¼ãƒ³åˆ¶ã‚«ãƒ¼ãƒ‰ãƒãƒˆãƒ«ã§å¡”ã‚’æ”»ç•¥ã›ã‚ˆï¼")
        print("\n    1. ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ")
        print("    2. éŠã³æ–¹")
        print("    3. çµ‚äº†")
        print()
    
    def display_how_to_play(self):
        """
        éŠã³æ–¹ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        ã‚²ãƒ¼ãƒ ã®åŸºæœ¬çš„ãªãƒ«ãƒ¼ãƒ«ã‚’èª¬æ˜ã—ã¾ã™ã€‚
        """
        print("\n" + "=" * 60)
        print("ã€éŠã³æ–¹ã€‘")
        print("=" * 60)
        print("""
ã“ã®ã‚²ãƒ¼ãƒ ã¯ã‚¿ãƒ¼ãƒ³åˆ¶ã®ã‚«ãƒ¼ãƒ‰ãƒãƒˆãƒ«ã‚²ãƒ¼ãƒ ã§ã™ã€‚

ã€åŸºæœ¬ãƒ«ãƒ¼ãƒ«ã€‘
1. æ¯ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã«ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒ3å›å¾©ã—ã€ã‚«ãƒ¼ãƒ‰ã‚’5æšå¼•ãã¾ã™
2. ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’æ¶ˆè²»ã—ã¦ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™
3. ã€Œã‚¿ãƒ¼ãƒ³çµ‚äº†ã€ã‚’é¸ã¶ã¨æ•µã®ã‚¿ãƒ¼ãƒ³ã«ãªã‚Šã¾ã™
4. æ•µã®HPã‚’0ã«ã™ã‚Œã°å‹åˆ©ï¼
5. è‡ªåˆ†ã®HPãŒ0ã«ãªã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼

ã€ã‚«ãƒ¼ãƒ‰ã®ç¨®é¡ã€‘
ğŸ—¡ï¸ æ”»æ’ƒã‚«ãƒ¼ãƒ‰: æ•µã«ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹
ğŸ›¡ï¸ é˜²å¾¡ã‚«ãƒ¼ãƒ‰: ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆã‚·ãƒ¼ãƒ«ãƒ‰ï¼‰ã‚’ç²å¾—
âœ¨ ã‚¹ã‚­ãƒ«ã‚«ãƒ¼ãƒ‰: å›å¾©ã‚„ç‰¹æ®ŠåŠ¹æœ

ã€ãƒ–ãƒ­ãƒƒã‚¯ã«ã¤ã„ã¦ã€‘
- ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ã‚‹ã¨ãã€å…ˆã«ãƒ–ãƒ­ãƒƒã‚¯ã§è»½æ¸›ã•ã‚Œã¾ã™
- ãƒ–ãƒ­ãƒƒã‚¯ã¯æ¯ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™

ã€æ•µã®ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã€‘
- æ•µã®æ¬¡ã®è¡Œå‹•ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
- æ”»æ’ƒã—ã¦ãã‚‹å ´åˆã¯é˜²å¾¡ã‚’æ¤œè¨ã—ã¾ã—ã‚‡ã†

ã€ç›®æ¨™ã€‘
å…¨ã¦ã®éšå±¤ã®æ•µã‚’å€’ã—ã¦ã€å¡”ã‚’æ”»ç•¥ã—ã‚ˆã†ï¼
        """)
        input("\nEnterã‚­ãƒ¼ã§æˆ»ã‚‹...")
    
    def display_map(self):
        """
        ãƒãƒƒãƒ—ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        ç¾åœ¨ã®éšå±¤æƒ…å ±ã¨é¸æŠè‚¢ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
        """
        print("\n" + "=" * 60)
        print(f"ğŸ—ºï¸ ãƒãƒƒãƒ— - {self.floor}éš")
        print("=" * 60)
        print(f"\n{self.player.get_status()}")
        print(f"ã‚´ãƒ¼ãƒ«ãƒ‰: {self.player.gold}G")
        print(f"æ’ƒç ´æ•°: {self.enemies_defeated}")
        print(f"\né€²è¡Œåº¦: {self.floor}/{self.max_floor}")
        
        # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’è¡¨ç¤º
        progress = "â–ˆ" * self.floor + "â–‘" * (self.max_floor - self.floor)
        print(f"[{progress}]")
        
        print("\nã€æ¬¡ã®è¡Œå‹•ã‚’é¸æŠã€‘")
        print("1. é€²ã‚€ï¼ˆæ•µã¨é­é‡ï¼‰")
        print("2. ä¼‘æ†©ï¼ˆHPå›å¾©ï¼‰")
        print("3. ãƒ‡ãƒƒã‚­ç¢ºèª")
        print("4. ã‚²ãƒ¼ãƒ çµ‚äº†")
    
    def handle_map_input(self):
        """
        ãƒãƒƒãƒ—ç”»é¢ã§ã®å…¥åŠ›ã‚’å‡¦ç†ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
        
        ã€æˆ»ã‚Šå€¤ã€‘
        - bool: ã‚²ãƒ¼ãƒ ã‚’ç¶šè¡Œã™ã‚‹ã‹ã©ã†ã‹
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠã«å¿œã˜ã¦é©åˆ‡ãªå‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚
        """
        choice = input("\n> ").strip()
        
        if choice == "1":
            # æ•µã¨é­é‡
            self.state = GameState.BATTLE
            return True
        
        elif choice == "2":
            # ä¼‘æ†©ï¼ˆHPå›å¾©ï¼‰
            heal_amount = 10
            actual_heal = self.player.heal(heal_amount)
            print(f"\nğŸ’¤ ä¼‘æ†©ã—ã¦HPãŒ{actual_heal}å›å¾©ã—ãŸï¼")
            print(f"ç¾åœ¨ã®HP: {self.player.current_hp}/{self.player.max_hp}")
            input("\nEnterã‚­ãƒ¼ã§ç¶šã‘ã‚‹...")
            return True
        
        elif choice == "3":
            # ãƒ‡ãƒƒã‚­ç¢ºèª
            self.display_deck()
            return True
        
        elif choice == "4":
            # ã‚²ãƒ¼ãƒ çµ‚äº†
            print("\nã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ (y/n)")
            confirm = input("> ").strip().lower()
            if confirm == "y":
                self.state = GameState.TITLE
                return False
            return True
        
        else:
            print("âš ï¸ ç„¡åŠ¹ãªé¸æŠã§ã™ã€‚")
            return True
    
    def display_deck(self):
        """
        ãƒ‡ãƒƒã‚­ã®å†…å®¹ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæŒã£ã¦ã„ã‚‹ã™ã¹ã¦ã®ã‚«ãƒ¼ãƒ‰ã‚’ä¸€è¦§è¡¨ç¤ºã—ã¾ã™ã€‚
        """
        print("\n" + "=" * 60)
        print("ğŸ“š ãƒ‡ãƒƒã‚­ä¸€è¦§")
        print("=" * 60)
        
        # ã™ã¹ã¦ã®ã‚«ãƒ¼ãƒ‰ã‚’é›†ã‚ã‚‹ï¼ˆãƒ‡ãƒƒã‚­ã€æ‰‹æœ­ã€æ¨ã¦æœ­ï¼‰
        all_cards = (
            self.player.deck +
            self.player.hand +
            self.player.discard_pile
        )
        
        if not all_cards:
            print("ãƒ‡ãƒƒã‚­ã«ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        else:
            # ã‚«ãƒ¼ãƒ‰ã‚’ç¨®é¡ã”ã¨ã«ã‚«ã‚¦ãƒ³ãƒˆ
            card_counts = {}
            for card in all_cards:
                if card.name in card_counts:
                    card_counts[card.name]["count"] += 1
                else:
                    card_counts[card.name] = {
                        "card": card,
                        "count": 1
                    }
            
            print(f"åˆè¨ˆ: {len(all_cards)}æš\n")
            for name, data in card_counts.items():
                card = data["card"]
                count = data["count"]
                print(f"  {card} Ã— {count}")
        
        input("\nEnterã‚­ãƒ¼ã§æˆ»ã‚‹...")
    
    def run_battle(self):
        """
        ãƒãƒˆãƒ«ã‚’å®Ÿè¡Œã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        1. æ•µã‚’ç”Ÿæˆ
        2. ãƒãƒˆãƒ«ã‚’é–‹å§‹
        3. çµæœã«å¿œã˜ã¦çŠ¶æ…‹ã‚’æ›´æ–°
        """
        # æ•µã‚’ç”Ÿæˆ
        enemy = create_random_enemy()
        
        # æœ€çµ‚éšå±¤ãªã‚‰ãƒœã‚¹ã‚’å¼·åŒ–
        if self.floor == self.max_floor:
            enemy.name = f"ãƒœã‚¹ãƒ»{enemy.name}"
            enemy.max_hp *= 2
            enemy.current_hp = enemy.max_hp
            enemy.attack_damage = int(enemy.attack_damage * 1.5)
        
        # ãƒãƒˆãƒ«ã‚’ä½œæˆã—ã¦å®Ÿè¡Œ
        battle = Battle(self.player, enemy)
        result = battle.run_battle()
        
        # çµæœã«å¿œã˜ãŸå‡¦ç†
        if result == "win":
            self.enemies_defeated += 1
            
            # å ±é…¬
            gold_reward = random.randint(10, 30) * self.floor
            self.player.gold += gold_reward
            print(f"\nğŸ’° {gold_reward}ã‚´ãƒ¼ãƒ«ãƒ‰ã‚’ç²å¾—ï¼")
            
            # æ¬¡ã®éšå±¤ã¸
            if self.floor >= self.max_floor:
                self.state = GameState.VICTORY
            else:
                self.floor += 1
                self.state = GameState.MAP
                print(f"\nâ¬†ï¸ {self.floor}éšã«é€²ã‚“ã ï¼")
        
        elif result == "lose":
            self.state = GameState.GAME_OVER
        
        elif result == "quit":
            self.state = GameState.TITLE
        
        if self.state not in [GameState.VICTORY, GameState.GAME_OVER, GameState.TITLE]:
            input("\nEnterã‚­ãƒ¼ã§ç¶šã‘ã‚‹...")
    
    def display_game_over(self):
        """
        ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
        """
        print("\n" + "=" * 60)
        print("    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
        print("    â•‘         ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼          â•‘")
        print("    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
        print("=" * 60)
        print(f"\nåˆ°é”éšå±¤: {self.floor}éš")
        print(f"æ’ƒç ´æ•°: {self.enemies_defeated}")
        print(f"ç²å¾—ã‚´ãƒ¼ãƒ«ãƒ‰: {self.player.gold}G")
        print("\nå†’é™ºè€…ã¯åŠ›å°½ããŸ...")
        input("\nEnterã‚­ãƒ¼ã§ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹...")
        self.state = GameState.TITLE
    
    def display_victory(self):
        """
        ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
        """
        print("\n" + "=" * 60)
        print("    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
        print("    â•‘    ğŸ‰ ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼ ğŸ‰    â•‘")
        print("    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
        print("=" * 60)
        print(f"\n{self.player.name}ã¯è¦‹äº‹ã€å¡”ã‚’æ”»ç•¥ã—ãŸï¼")
        print(f"\nã€æœ€çµ‚æˆç¸¾ã€‘")
        print(f"  æ’ƒç ´æ•°: {self.enemies_defeated}")
        print(f"  ç²å¾—ã‚´ãƒ¼ãƒ«ãƒ‰: {self.player.gold}G")
        print(f"  æ®‹ã‚ŠHP: {self.player.current_hp}/{self.player.max_hp}")
        print("\nãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼")
        input("\nEnterã‚­ãƒ¼ã§ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹...")
        self.state = GameState.TITLE
    
    def run(self):
        """
        ã‚²ãƒ¼ãƒ ã®ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿè¡Œã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã«å¿œã˜ã¦é©åˆ‡ãªç”»é¢è¡¨ç¤ºã¨å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚
        ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã™ã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—ã—ç¶šã‘ã¾ã™ã€‚
        
        ã€è§£èª¬ã€‘
        ã“ã‚ŒãŒã‚²ãƒ¼ãƒ å…¨ä½“ã®ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ã§ã™ã€‚
        å„çŠ¶æ…‹ï¼ˆstateï¼‰ã«å¿œã˜ã¦ç•°ãªã‚‹å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚
        """
        self.running = True
        
        print("\nğŸ® ãƒ­ãƒ¼ã‚°ãƒ©ã‚¤ã‚¯ãƒ»ã‚«ãƒ¼ãƒ‰ãƒãƒˆãƒ«ã¸ã‚ˆã†ã“ãï¼ ğŸ®")
        
        while self.running:
            # çŠ¶æ…‹ã«å¿œã˜ãŸå‡¦ç†ã‚’å®Ÿè¡Œ
            if self.state == GameState.TITLE:
                self.display_title()
                choice = input("> ").strip()
                
                if choice == "1":
                    self.start_new_game()
                elif choice == "2":
                    self.display_how_to_play()
                elif choice == "3":
                    print("\nğŸ‘‹ ã¾ãŸã­ï¼")
                    self.running = False
                else:
                    print("âš ï¸ 1, 2, 3 ã®ã„ãšã‚Œã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
            
            elif self.state == GameState.MAP:
                self.display_map()
                if not self.handle_map_input():
                    continue
            
            elif self.state == GameState.BATTLE:
                self.run_battle()
            
            elif self.state == GameState.GAME_OVER:
                self.display_game_over()
            
            elif self.state == GameState.VICTORY:
                self.display_victory()
        
        print("\nã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚")


# =============================================================================
# ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ¼ãƒ‰
# =============================================================================
if __name__ == "__main__":
    # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥å®Ÿè¡Œã—ãŸå ´åˆã€ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
    game = GameManager()
    game.run()
