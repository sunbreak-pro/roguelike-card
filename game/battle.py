# =============================================================================
# battle.py - ãƒãƒˆãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…
# =============================================================================
#
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã€ã‚¿ãƒ¼ãƒ³åˆ¶ãƒãƒˆãƒ«ã®ä»•çµ„ã¿ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚
#
# ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§å­¦ã¹ã‚‹ã“ã¨ã€‘
# - ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã®å®Ÿè£…
# - ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®å‡¦ç†
# - çŠ¶æ…‹ç®¡ç†ï¼ˆã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³çš„ãªè€ƒãˆæ–¹ï¼‰
# - ãƒªã‚¹ãƒˆã®æ“ä½œï¼ˆã‚·ãƒ£ãƒƒãƒ•ãƒ«ã€è¿½åŠ ã€å‰Šé™¤ï¼‰
#
# =============================================================================

import random  # ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚„ãƒ©ãƒ³ãƒ€ãƒ é¸æŠã«ä½¿ç”¨


# =============================================================================
# Battle ã‚¯ãƒ©ã‚¹ - ãƒãƒˆãƒ«ã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹
# =============================================================================
class Battle:
    """
    ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨æ•µã®ãƒãƒˆãƒ«ã‚’ç®¡ç†ã™ã‚‹ã‚¯ãƒ©ã‚¹ã§ã™ã€‚
    
    ã€è§£èª¬ã€‘
    ãƒãƒˆãƒ«ã®æµã‚Œï¼š
    1. ãƒãƒˆãƒ«é–‹å§‹ï¼ˆsetupï¼‰
    2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹
    3. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ï¼ˆç¹°ã‚Šè¿”ã—ï¼‰
    4. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã‚¿ãƒ¼ãƒ³çµ‚äº†ã‚’å®£è¨€
    5. æ•µã®ã‚¿ãƒ¼ãƒ³
    6. 2ã«æˆ»ã‚‹ï¼ˆã©ã¡ã‚‰ã‹ãŒå€’ã‚Œã‚‹ã¾ã§ï¼‰
    7. ãƒãƒˆãƒ«çµ‚äº†
    
    ã“ã®ã‚¯ãƒ©ã‚¹ã¯ä¸Šè¨˜ã®æµã‚Œã‚’ç®¡ç†ã—ã€å„çŠ¶æ…‹ã§é©åˆ‡ãªå‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚
    """
    
    def __init__(self, player, enemy):
        """
        ãƒãƒˆãƒ«ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
        
        ã€å¼•æ•°ã®èª¬æ˜ã€‘
        - player: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        - enemy: æ•µã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        ãƒãƒˆãƒ«ã«å¿…è¦ãªæƒ…å ±ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚
        """
        # ãƒãƒˆãƒ«ã«å‚åŠ ã™ã‚‹ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
        self.player = player
        self.enemy = enemy
        
        # ã‚¿ãƒ¼ãƒ³æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ
        # ãƒãƒˆãƒ«é–‹å§‹æ™‚ã¯0ã€å„ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã«ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
        self.turn_count = 0
        
        # 1ã‚¿ãƒ¼ãƒ³ã«å¼•ãã‚«ãƒ¼ãƒ‰ã®æšæ•°
        self.cards_per_turn = 5
        
        # ãƒãƒˆãƒ«ãŒçµ‚äº†ã—ãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
        # True ã«ãªã‚‹ã¨ãƒãƒˆãƒ«ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã¾ã™
        self.battle_ended = False
        
        # ãƒãƒˆãƒ«ã®å‹æ•—çµæœ
        # "win": ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‹åˆ©
        # "lose": ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ•—åŒ—
        # None: ã¾ã æ±ºç€ãŒã¤ã„ã¦ã„ãªã„
        self.result = None
    
    def setup_battle(self):
        """
        ãƒãƒˆãƒ«é–‹å§‹æ™‚ã®æº–å‚™ã‚’è¡Œã†ãƒ¡ã‚½ãƒƒãƒ‰
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        1. ãƒ‡ãƒƒã‚­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹
        2. æœ€åˆã®ã‚¿ãƒ¼ãƒ³ã‚’é–‹å§‹ã™ã‚‹
        
        ã€è§£èª¬ã€‘
        ãƒãƒˆãƒ«é–‹å§‹æ™‚ã«1å›ã ã‘å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
        ãƒ‡ãƒƒã‚­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹ã“ã¨ã§ã€æ¯å›ç•°ãªã‚‹å±•é–‹ã«ãªã‚Šã¾ã™ã€‚
        """
        print("\n" + "=" * 50)
        print(f"âš”ï¸ ãƒãƒˆãƒ«é–‹å§‹ï¼ vs {self.enemy.name} âš”ï¸")
        print("=" * 50)
        
        # æ•µã®æƒ…å ±ã‚’è¡¨ç¤º
        if self.enemy.description:
            print(f"ã€Œ{self.enemy.description}ã€")
        
        # ãƒ‡ãƒƒã‚­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        # random.shuffle() ã¯ãƒªã‚¹ãƒˆã®è¦ç´ ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸¦ã³æ›¿ãˆã¾ã™
        # å…ƒã®ãƒªã‚¹ãƒˆãŒç›´æ¥å¤‰æ›´ã•ã‚Œã¾ã™ï¼ˆç ´å£Šçš„æ“ä½œï¼‰
        random.shuffle(self.player.deck)
        
        # æ¨ã¦æœ­ã¨æ‰‹æœ­ã‚’ã‚¯ãƒªã‚¢
        self.player.hand = []
        self.player.discard_pile = []
        
        # æ•µã®æœ€åˆã®è¡Œå‹•ã‚’æ±ºå®š
        self.enemy.decide_action()
    
    def start_player_turn(self):
        """
        ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹å‡¦ç†ã‚’è¡Œã†ãƒ¡ã‚½ãƒƒãƒ‰
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        1. ã‚¿ãƒ¼ãƒ³æ•°ã‚’å¢—ã‚„ã™
        2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹å‡¦ç†ï¼ˆã‚¨ãƒãƒ«ã‚®ãƒ¼å›å¾©ãªã©ï¼‰
        3. ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã
        4. ç¾åœ¨ã®çŠ¶æ³ã‚’è¡¨ç¤º
        """
        # ã‚¿ãƒ¼ãƒ³æ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆï¼ˆ1å¢—ã‚„ã™ï¼‰
        self.turn_count += 1
        
        print("\n" + "-" * 50)
        print(f"ğŸ¯ ã‚¿ãƒ¼ãƒ³ {self.turn_count} - ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³")
        print("-" * 50)
        
        # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹å‡¦ç†ã‚’å‘¼ã³å‡ºã™
        # ã‚¨ãƒãƒ«ã‚®ãƒ¼å›å¾©ã€ãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚»ãƒƒãƒˆãŒè¡Œã‚ã‚Œã¾ã™
        self.player.start_turn()
        
        # ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã
        self.draw_cards(self.cards_per_turn)
        
        # æ•µã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ•µã®ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã¨åŒç­‰ï¼‰
        self.enemy.reset_block()
        
        # ç¾åœ¨ã®çŠ¶æ³ã‚’è¡¨ç¤º
        self.display_battle_state()
    
    def draw_cards(self, count):
        """
        ã‚«ãƒ¼ãƒ‰ã‚’å¼•ããƒ¡ã‚½ãƒƒãƒ‰
        
        ã€å¼•æ•°ã®èª¬æ˜ã€‘
        - count: å¼•ãã‚«ãƒ¼ãƒ‰ã®æšæ•°
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        1. ãƒ‡ãƒƒã‚­ã‹ã‚‰ã‚«ãƒ¼ãƒ‰ã‚’æ‰‹æœ­ã«ç§»å‹•
        2. ãƒ‡ãƒƒã‚­ãŒç©ºã«ãªã£ãŸã‚‰ã€æ¨ã¦æœ­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ãƒ‡ãƒƒã‚­ã«æˆ»ã™
        3. å¼•ã„ãŸã‚«ãƒ¼ãƒ‰ã®æƒ…å ±ã‚’è¡¨ç¤º
        
        ã€è§£èª¬ã€‘
        ã“ã®å‡¦ç†ã¯ãƒ­ãƒ¼ã‚°ãƒ©ã‚¤ã‚¯ç³»ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ã®é‡è¦ãªè¦ç´ ã§ã™ã€‚
        ãƒ‡ãƒƒã‚­ã‚’ä½¿ã„åˆ‡ã‚‹ã¨æ¨ã¦æœ­ãŒå±±æœ­ã«æˆ»ã‚‹ãŸã‚ã€
        ã™ã¹ã¦ã®ã‚«ãƒ¼ãƒ‰ãŒå¾ªç’°ã—ã¦ä½¿ã‚ã‚Œã¾ã™ã€‚
        """
        cards_drawn = 0  # å®Ÿéš›ã«å¼•ã„ãŸã‚«ãƒ¼ãƒ‰ã®æ•°
        
        for _ in range(count):
            # ãƒ‡ãƒƒã‚­ãŒç©ºã®å ´åˆã€æ¨ã¦æœ­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ãƒ‡ãƒƒã‚­ã«æˆ»ã™
            if len(self.player.deck) == 0:
                if len(self.player.discard_pile) == 0:
                    # æ¨ã¦æœ­ã‚‚ç©ºãªã‚‰ã€ã“ã‚Œä»¥ä¸Šå¼•ã‘ãªã„
                    print("â€» ã“ã‚Œä»¥ä¸Šã‚«ãƒ¼ãƒ‰ã‚’å¼•ã‘ã¾ã›ã‚“")
                    break
                
                # æ¨ã¦æœ­ã‚’ãƒ‡ãƒƒã‚­ã«ç§»å‹•
                # ãƒªã‚¹ãƒˆã®ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆã—ã¦ã‹ã‚‰ã‚¯ãƒªã‚¢ã—ã¾ã™
                self.player.deck = self.player.discard_pile.copy()
                self.player.discard_pile = []
                
                # ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                random.shuffle(self.player.deck)
                print("ğŸ“š æ¨ã¦æœ­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ãƒ‡ãƒƒã‚­ã«æˆ»ã—ã¾ã—ãŸï¼")
            
            # ãƒ‡ãƒƒã‚­ã®ä¸€ç•ªä¸Šã‹ã‚‰ã‚«ãƒ¼ãƒ‰ã‚’å–ã‚Šå‡ºã™
            # pop() ã¯ãƒªã‚¹ãƒˆã®æœ€å¾Œã®è¦ç´ ã‚’å–ã‚Šå‡ºã—ã¦å‰Šé™¤ã—ã¾ã™
            card = self.player.deck.pop()
            
            # æ‰‹æœ­ã«è¿½åŠ 
            self.player.hand.append(card)
            cards_drawn += 1
        
        print(f"ğŸƒ ã‚«ãƒ¼ãƒ‰ã‚’{cards_drawn}æšå¼•ãã¾ã—ãŸ")
    
    def display_battle_state(self):
        """
        ãƒãƒˆãƒ«ã®ç¾åœ¨çŠ¶æ³ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        1. æ•µã®çŠ¶æ…‹ã¨ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã‚’è¡¨ç¤º
        2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
        3. æ‰‹æœ­ã®ã‚«ãƒ¼ãƒ‰ä¸€è¦§ã‚’è¡¨ç¤º
        
        ã€è§£èª¬ã€‘
        ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒåˆ¤æ–­ã‚’ä¸‹ã™ãŸã‚ã«å¿…è¦ãªæƒ…å ±ã‚’
        åˆ†ã‹ã‚Šã‚„ã™ãè¡¨ç¤ºã—ã¾ã™ã€‚
        """
        print("\nã€ãƒãƒˆãƒ«çŠ¶æ³ã€‘")
        
        # æ•µã®æƒ…å ±
        print(f"ğŸ‘¹ {self.enemy.get_status()}")
        print(f"   æ¬¡ã®è¡Œå‹•: {self.enemy.get_intent_display()}")
        
        # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æƒ…å ±
        print(f"ğŸ§™ {self.player.get_status()}")
        
        # æ‰‹æœ­ã®è¡¨ç¤º
        print("\nã€æ‰‹æœ­ã€‘")
        if len(self.player.hand) == 0:
            print("  ï¼ˆæ‰‹æœ­ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰")
        else:
            for i, card in enumerate(self.player.hand, 1):
                # ä½¿ç”¨å¯èƒ½ã‹ã©ã†ã‹ã‚’åˆ¤å®š
                can_use = "âœ…" if self.player.can_use_card(card) else "âŒ"
                print(f"  {i}. {can_use} {card}")
        
        # ãƒ‡ãƒƒã‚­ã¨æ¨ã¦æœ­ã®æšæ•°
        print(f"\nğŸ“š ãƒ‡ãƒƒã‚­: {len(self.player.deck)}æš | æ¨ã¦æœ­: {len(self.player.discard_pile)}æš")
    
    def get_player_action(self):
        """
        ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œå‹•å…¥åŠ›ã‚’å—ã‘ä»˜ã‘ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
        
        ã€æˆ»ã‚Šå€¤ã€‘
        - tuple: (è¡Œå‹•ã‚¿ã‚¤ãƒ—, å€¤)
          - ("card", ã‚«ãƒ¼ãƒ‰ç•ªå·): ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
          - ("end", None): ã‚¿ãƒ¼ãƒ³çµ‚äº†
          - ("quit", None): ã‚²ãƒ¼ãƒ çµ‚äº†
          - (None, None): ç„¡åŠ¹ãªå…¥åŠ›
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        1. é¸æŠè‚¢ã‚’è¡¨ç¤º
        2. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’å—ã‘ä»˜ã‘
        3. å…¥åŠ›ã‚’è§£æã—ã¦é©åˆ‡ãªå€¤ã‚’è¿”ã™
        
        ã€è§£èª¬ã€‘
        ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã¯äºˆæœŸã—ãªã„å€¤ãŒæ¥ã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€
        try-except ã§ä¾‹å¤–å‡¦ç†ã‚’è¡Œã„ã€ã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«å‡¦ç†ã—ã¾ã™ã€‚
        """
        print("\nã€è¡Œå‹•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‘")
        print("  ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ã†: ã‚«ãƒ¼ãƒ‰ç•ªå·ã‚’å…¥åŠ› (1, 2, 3, ...)")
        print("  ã‚¿ãƒ¼ãƒ³çµ‚äº†: e ã¾ãŸã¯ end")
        print("  ã‚²ãƒ¼ãƒ çµ‚äº†: q ã¾ãŸã¯ quit")
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’å—ã‘ä»˜ã‘
        # input() ã¯æ–‡å­—åˆ—ã‚’è¿”ã—ã¾ã™
        user_input = input("\n> ").strip().lower()
        
        # å…¥åŠ›ã®è§£æ
        if user_input in ["e", "end", "çµ‚äº†"]:
            return ("end", None)
        
        if user_input in ["q", "quit", "ã‚„ã‚ã‚‹"]:
            return ("quit", None)
        
        # æ•°å­—ã¨ã—ã¦è§£æã‚’è©¦ã¿ã‚‹
        try:
            # int() ã§æ•´æ•°ã«å¤‰æ›
            card_number = int(user_input)
            return ("card", card_number)
        except ValueError:
            # æ•°å­—ã§ãªã„å ´åˆã¯ValueErrorãŒç™ºç”Ÿ
            print("âš ï¸ ç„¡åŠ¹ãªå…¥åŠ›ã§ã™ã€‚ã‚‚ã†ä¸€åº¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
            return (None, None)
    
    def use_card(self, card_index):
        """
        ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
        
        ã€å¼•æ•°ã®èª¬æ˜ã€‘
        - card_index: ä½¿ç”¨ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã®ç•ªå·ï¼ˆ1å§‹ã¾ã‚Šï¼‰
        
        ã€æˆ»ã‚Šå€¤ã€‘
        - bool: ã‚«ãƒ¼ãƒ‰ã®ä½¿ç”¨ã«æˆåŠŸã—ãŸã‹ã©ã†ã‹
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        1. ã‚«ãƒ¼ãƒ‰ç•ªå·ã®å¦¥å½“æ€§ã‚’ãƒã‚§ãƒƒã‚¯
        2. ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒè¶³ã‚Šã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        3. ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
        4. ã‚«ãƒ¼ãƒ‰ã‚’æ¨ã¦æœ­ã«ç§»å‹•
        """
        # ã‚«ãƒ¼ãƒ‰ç•ªå·ã®ç¯„å›²ãƒã‚§ãƒƒã‚¯
        # card_index ã¯1å§‹ã¾ã‚Šãªã®ã§ã€ãƒªã‚¹ãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0å§‹ã¾ã‚Šï¼‰ã«å¤‰æ›
        if card_index < 1 or card_index > len(self.player.hand):
            print("âš ï¸ ãã®ç•ªå·ã®ã‚«ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚")
            return False
        
        # ãƒªã‚¹ãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å¤‰æ›ï¼ˆ0å§‹ã¾ã‚Šï¼‰
        index = card_index - 1
        card = self.player.hand[index]
        
        # ã‚¨ãƒãƒ«ã‚®ãƒ¼ãƒã‚§ãƒƒã‚¯
        if not self.player.can_use_card(card):
            print(f"âš ï¸ ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒè¶³ã‚Šã¾ã›ã‚“ï¼ï¼ˆå¿…è¦: {card.cost}, ç¾åœ¨: {self.player.current_energy}ï¼‰")
            return False
        
        # ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’æ¶ˆè²»
        self.player.use_energy(card.cost)
        
        # ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
        # card.use() ã¯ä½¿ç”¨çµæœã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã—ã¾ã™
        result_message = card.use(self.player, self.enemy)
        print(f"\nğŸ’¥ {result_message}")
        
        # æ‰‹æœ­ã‹ã‚‰ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤
        # pop(index) ã§æŒ‡å®šä½ç½®ã®è¦ç´ ã‚’å–ã‚Šå‡ºã—ã¦å‰Šé™¤
        self.player.hand.pop(index)
        
        # æ¨ã¦æœ­ã«è¿½åŠ 
        self.player.discard_pile.append(card)
        
        return True
    
    def player_turn(self):
        """
        ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³å…¨ä½“ã‚’å‡¦ç†ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
        
        ã€æˆ»ã‚Šå€¤ã€‘
        - bool: ã‚²ãƒ¼ãƒ ã‚’ç¶šè¡Œã™ã‚‹ã‹ã©ã†ã‹ï¼ˆFalseãªã‚‰çµ‚äº†ï¼‰
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        1. ã‚¿ãƒ¼ãƒ³é–‹å§‹å‡¦ç†
        2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œå‹•ã‚’ç¹°ã‚Šè¿”ã—å—ã‘ä»˜ã‘
        3. ã‚¿ãƒ¼ãƒ³çµ‚äº†ãŒé¸æŠã•ã‚Œã‚‹ã‹ã€ãƒãƒˆãƒ«ãŒçµ‚äº†ã™ã‚‹ã¾ã§ç¶šã‘ã‚‹
        
        ã€è§£èª¬ã€‘
        while True ã®ãƒ«ãƒ¼ãƒ—ã§ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã€Œã‚¿ãƒ¼ãƒ³çµ‚äº†ã€ã‚’
        é¸æŠã™ã‚‹ã¾ã§è¡Œå‹•ã‚’å—ã‘ä»˜ã‘ç¶šã‘ã¾ã™ã€‚
        """
        # ã‚¿ãƒ¼ãƒ³é–‹å§‹å‡¦ç†
        self.start_player_turn()
        
        # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¡Œå‹•ãƒ«ãƒ¼ãƒ—
        while True:
            # æ•µãŒå€’ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if not self.enemy.is_alive():
                self.battle_ended = True
                self.result = "win"
                return True
            
            # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¥åŠ›ã‚’å–å¾—
            action_type, action_value = self.get_player_action()
            
            if action_type == "card":
                # ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
                success = self.use_card(action_value)
                if success:
                    # ãƒãƒˆãƒ«çŠ¶æ³ã‚’æ›´æ–°è¡¨ç¤º
                    self.display_battle_state()
            
            elif action_type == "end":
                # ã‚¿ãƒ¼ãƒ³çµ‚äº†
                print("\nğŸ”š ã‚¿ãƒ¼ãƒ³ã‚’çµ‚äº†ã—ã¾ã™...")
                self.end_player_turn()
                return True
            
            elif action_type == "quit":
                # ã‚²ãƒ¼ãƒ çµ‚äº†
                print("\nğŸšª ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™...")
                return False
            
            # action_type == None ã®å ´åˆã¯ä½•ã‚‚ã›ãšãƒ«ãƒ¼ãƒ—ã‚’ç¶šã‘ã‚‹
    
    def end_player_turn(self):
        """
        ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³çµ‚äº†å‡¦ç†ã‚’è¡Œã†ãƒ¡ã‚½ãƒƒãƒ‰
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        1. æ‰‹æœ­ã®ã‚«ãƒ¼ãƒ‰ã‚’ã™ã¹ã¦æ¨ã¦æœ­ã«ç§»å‹•
        
        ã€è§£èª¬ã€‘
        å¤šãã®ãƒ­ãƒ¼ã‚°ãƒ©ã‚¤ã‚¯ç³»ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ã§ã¯ã€
        ã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã«ä½¿ã‚ãªã‹ã£ãŸã‚«ãƒ¼ãƒ‰ã‚‚æ¨ã¦æœ­ã«è¡Œãã¾ã™ã€‚
        ã“ã‚Œã«ã‚ˆã‚Šã€æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã«ã¯æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã‘ã¾ã™ã€‚
        """
        # æ‰‹æœ­ã‚’ã™ã¹ã¦æ¨ã¦æœ­ã«ç§»å‹•
        # extend() ã¯åˆ¥ã®ãƒªã‚¹ãƒˆã®å…¨è¦ç´ ã‚’è¿½åŠ ã—ã¾ã™
        self.player.discard_pile.extend(self.player.hand)
        
        # æ‰‹æœ­ã‚’ã‚¯ãƒªã‚¢
        self.player.hand = []
    
    def enemy_turn(self):
        """
        æ•µã®ã‚¿ãƒ¼ãƒ³ã‚’å‡¦ç†ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        1. æ•µãŒç”Ÿå­˜ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        2. æ•µã®è¡Œå‹•ã‚’å®Ÿè¡Œ
        3. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç”Ÿå­˜ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        4. æ¬¡ã®æ•µã®è¡Œå‹•ã‚’æ±ºå®š
        """
        # æ•µãŒå€’ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if not self.enemy.is_alive():
            return
        
        print("\n" + "-" * 50)
        print(f"ğŸ‘¹ {self.enemy.name}ã®ã‚¿ãƒ¼ãƒ³")
        print("-" * 50)
        
        # æ•µã®è¡Œå‹•ã‚’å®Ÿè¡Œ
        action_result = self.enemy.take_action(self.player)
        print(f"\nâš¡ {action_result}")
        
        # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç”Ÿå­˜ãƒã‚§ãƒƒã‚¯
        if not self.player.is_alive():
            self.battle_ended = True
            self.result = "lose"
            return
        
        # æ¬¡ã®è¡Œå‹•ã‚’æ±ºå®šï¼ˆæ¬¡ã®ã‚¿ãƒ¼ãƒ³ã«å‘ã‘ã¦ï¼‰
        self.enemy.decide_action()
        
        # ç¾åœ¨ã®çŠ¶æ³ã‚’è¡¨ç¤º
        print(f"\n{self.player.get_status()}")
    
    def run_battle(self):
        """
        ãƒãƒˆãƒ«å…¨ä½“ã‚’å®Ÿè¡Œã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
        
        ã€æˆ»ã‚Šå€¤ã€‘
        - str: ãƒãƒˆãƒ«ã®çµæœ ("win" ã¾ãŸã¯ "lose")
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        1. ãƒãƒˆãƒ«ã®æº–å‚™
        2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨æ•µã®ã‚¿ãƒ¼ãƒ³ã‚’äº¤äº’ã«ç¹°ã‚Šè¿”ã™
        3. ã©ã¡ã‚‰ã‹ãŒå€’ã‚ŒãŸã‚‰ãƒãƒˆãƒ«çµ‚äº†
        4. çµæœã‚’è¿”ã™
        
        ã€è§£èª¬ã€‘
        ã“ã‚ŒãŒãƒãƒˆãƒ«ã®ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ã§ã™ã€‚
        while not self.battle_ended ã§ã€ãƒãƒˆãƒ«ãŒçµ‚äº†ã™ã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—ã—ã¾ã™ã€‚
        """
        # ãƒãƒˆãƒ«æº–å‚™
        self.setup_battle()
        
        # ãƒ¡ã‚¤ãƒ³ãƒãƒˆãƒ«ãƒ«ãƒ¼ãƒ—
        while not self.battle_ended:
            # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³
            continue_game = self.player_turn()
            
            # ã‚²ãƒ¼ãƒ çµ‚äº†ãŒé¸æŠã•ã‚ŒãŸå ´åˆ
            if not continue_game:
                self.result = "quit"
                break
            
            # ãƒãƒˆãƒ«ãŒçµ‚äº†ã—ã¦ã„ãªã‘ã‚Œã°æ•µã®ã‚¿ãƒ¼ãƒ³
            if not self.battle_ended:
                self.enemy_turn()
        
        # ãƒãƒˆãƒ«çµæœã®è¡¨ç¤º
        self.display_battle_result()
        
        return self.result
    
    def display_battle_result(self):
        """
        ãƒãƒˆãƒ«çµæœã‚’è¡¨ç¤ºã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
        
        ã€å®Ÿè¡Œå†…å®¹ã€‘
        å‹æ•—ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
        """
        print("\n" + "=" * 50)
        
        if self.result == "win":
            print("ğŸ‰ å‹åˆ©ï¼ ğŸ‰")
            print(f"{self.enemy.name}ã‚’å€’ã—ãŸï¼")
        elif self.result == "lose":
            print("ğŸ’€ æ•—åŒ—... ğŸ’€")
            print(f"{self.enemy.name}ã«å€’ã•ã‚Œã¦ã—ã¾ã£ãŸ...")
        elif self.result == "quit":
            print("ğŸšª ã‚²ãƒ¼ãƒ ã‚’ä¸­æ–­ã—ã¾ã—ãŸ")
        
        print("=" * 50)


# =============================================================================
# ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ¼ãƒ‰
# =============================================================================
if __name__ == "__main__":
    # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥å®Ÿè¡Œã—ãŸå ´åˆã®ãƒ†ã‚¹ãƒˆ
    from character import Player, Slime
    from card import create_starting_deck
    
    print("=== ãƒãƒˆãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆ ===")
    
    # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆ
    player = Player("ãƒ†ã‚¹ãƒˆå‹‡è€…")
    player.deck = create_starting_deck()
    
    # æ•µã‚’ä½œæˆ
    enemy = Slime()
    
    # ãƒãƒˆãƒ«ã‚’ä½œæˆã—ã¦å®Ÿè¡Œ
    battle = Battle(player, enemy)
    result = battle.run_battle()
    
    print(f"\nãƒãƒˆãƒ«çµæœ: {result}")
