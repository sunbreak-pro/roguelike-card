# キャンプ施設詳細設計書 & 実装手順書 (Version 1.0)

## 1. 共通 UI/UX コンセプト

- **トーン & マナー**:
- ダークファンタジー調（既存の `BaseCamp.css` を継承）。
- 黒・紫・濃紺を基調とし、アクセントにゴールド（金）やエメラルド（魔石）、淡い青（魂）を使用。

- **共通レイアウト構造**:
- **ヘッダー**: 常にリソース（Gold, Magic Stone, Soul Residue）を表示。
- **ナビゲーション**: 画面左上または下部に「キャンプへ戻る」ボタンを常設。
- **メインエリア**: 施設ごとの機能画面。モーダルや全画面遷移で表示。
- **フィードバック**: アクション（購入、強化など）成功時にパーティクルや SE、トースト通知を行う。

---

## 2. 施設別 UI/UX 詳細設計

### 2.1 ギルド（酒場・掲示板） - The Guild Tavern

**目的**: 情報収集、クエスト管理、称号報酬。

**画面構成**:

- **背景**: 賑やかな酒場の店内（暗め）。
- **レイアウト**: 3 つのタブ切り替え式 `[噂話 (Rumors)]` `[依頼 (Quests)]` `[称号 (Titles)]`

1. **噂話タブ**:

- リスト表示: 「魔石の噂 (50G)」「商人の噂 (100G)」など。
- 購入ボタン: クリックで Gold 消費 → 「次回の探索で適用」フラグが立つ。
- 状態表示: 購入済みは「適用中 (Active)」と表示。

2. **依頼タブ**:

- カードリスト: 「デイリー: 特定の敵を 10 体討伐」「ウィークリー: ボス討伐」,「最終目標: 深層到達」
- プログレスバー: `7/10` のような進捗表示。
- 報酬受取ボタン: 達成時にアクティブ化。

3. **称号タブ**:

- グリッド表示: バッジアイコン一覧
- 詳細モーダル: クリックで獲得条件と報酬（永続バフやアイテム）を表示

**インタラクション**:

- マスター（NPC）のセリフ吹き出しをランダム表示（世界観の補強）

---

### 2.2 武具店（取引所） - Merchant's Exchange

**目的**: アイテム売買、転移石の補充。

**画面構成**:

- **モード切替**: `[購入 (Buy)]` `[売却 (Sell)]` のトグルスイッチ。
- **購入画面**:
- カテゴリフィルタ: `[全て]` `[消耗品]` `[装備パック]` `[転移石]`
- 商品カード: アイコン、名前、価格、所持数。
- _重要_: `return_system.md` に基づき「転移石」は在庫切れなしで常に陳列。
- 「日替わりセール」品には `SALE -20%` のバッジ。

- **売却画面**:
- インベントリグリッド: プレイヤーの持ち物を表示。
- 一括選択モード: 不要な装備を複数選択してまとめて売却。
- 魔石換金ボタン: 「魔石を売却（1 個=50G）」のクイックアクション。

**UX の工夫**:

- 購入時、「チャリーン」というコイン音とエフェクト。

---

### 2.3 鍛冶屋（工房） - The Blacksmith

**目的**: 装備の強化、修理、解体。

**画面構成**:

- **レイアウト**: 画面左に装備リスト、右にアクションパネル。
- **左パネル（装備選択）**:
- 装備部位ごとのタブ、または全一覧。
- 耐久度（AP）が低い装備は赤くハイライト。

- **右パネル（アクション）**: 3 つのアクションタブ。

1. **強化 (Upgrade)**:

- `EQUIPMENT_AND_ITEMS_DESIGN.md` のコスト表に基づく表示。
- `Current: Lv1` → `Next: Lv2` のステータス比較（緑色で上昇値を強調）。
- 必要素材: Gold アイコンと魔石アイコンで使用量を表示。不足時は赤字。

2. **修理 (Repair)**:

- スライダーまたはボタンで修理量を選択（最大まで / 50%回復）。
- コスト表示（Gold のみ）。

3. **解体 (Dismantle)**:

- 得られる素材（魔石、かけら）のプレビュー表示。
- **警告モーダル**: レア以上を解体する際は確認ダイアログを出す。

---

### 2.4 神殿（聖域） - The Sanctuary

**目的**: 魂の残滓を使った恒久強化（ローグライト要素）。

**画面構成**:

- **ビジュアル**: 荘厳な神殿内部、ステンドグラスから光。中央に「魂の器（現在の所持数）」。
- **スキルツリー**:
- 中心から放射状、またはツリー状に伸びるノード。
- ノードアイコン: HP（ハート）、Gold（コイン袋）、鑑定（目）、インベントリ（鞄）。

- **ノード詳細**:
- ホバー/タップで効果説明と必要コストを表示。
- 解放済みは点灯、解放可能は点滅、不可はグレーアウト。

**UX の工夫**:

- 解放時、聖なる光のエフェクトと重厚な SE。
- 魂を注ぐような長押しインタラクション（誤操作防止と儀式感）。

---

### 2.5 図書館（書庫） - The Grand Library

**目的**: デッキ編成、図鑑、記録。

**画面構成**:

- **メインメニュー**: 本棚に並ぶ本を選択 `[デッキ編成]` `[カード図鑑]` `[魔物図鑑]` `[歴史書(戦績)]`
- **デッキ編成画面**:
- 現在の初期デッキ（カードリスト）。
- カードプール（所持しているアンロック済みカード）。
- ドラッグ&ドロップで入れ替え。
- コスト分布グラフ（マナカーブ）の簡易表示。

- **図鑑**:
- 未発見の項目はシルエット表示。
- カードをクリックで熟練度詳細を表示。

---

### 2.6 倉庫（自室） - Player's Quarters

**目的**: 装備変更（ロードアウト）。

**画面構成**:

- **キャラクター表示**: 中央にプレイヤーキャラの立ち絵。
- **装備スロット**: キャラ周辺に 6 つのスロット（頭、胴、右、左、足、アクセ）。
- **インベントリ**: 画面下部または横に所持装備一覧。
- **操作**:
- スロットをクリック → 該当部位の装備リストが開く → 選択して装備。
- 詳細ポップアップでセット効果やスキルを確認。

- **ロードアウト保存**: `[セット1] [セット2]` の保存/読込ボタン。

---

## 3. 実装手順書

既存の `roguelike-card-battle` プロジェクトへの追加実装手順です。

### Step 1: データ構造と型定義の整備

まず、各施設で扱うデータの型を定義します。`src/types/CampTypes.ts` (新規作成推奨) などにまとめます。

```typescript
// src/types/CampTypes.ts (例)

// リソース管理
export interface PlayerResources {
  gold: number;
  magicStones: number; // 魔石
  soulResidue: number; // 魂の残滓
}

// ギルド：噂話
export interface Rumor {
  id: string;
  name: string;
  effectDescription: string;
  cost: number;
  isActive: boolean;
}

// 鍛冶屋：強化コスト
export interface UpgradeCost {
  gold: number;
  stones: number;
}
```

### Step 2: グローバル状態管理の更新 (Context/Store)

`BaseCamp.tsx` は現在ローカル state で表示を切り替えていますが、リソースや購入状態はアプリケーション全体（特にダンジョンパート）と共有する必要があります。
`GameContext` または `CampContext` を作成し、以下を管理します。

- 所持金、魔石、魂の残滓
- 所持アイテム（インベントリ）
- 所持装備
- 適用中の噂話フラグ
- 解放済みの神殿スキル

### Step 3: 各施設コンポーネントの実装

`src/ui/campsUI/facilities/` ディレクトリを作成し、各ファイルを配置します。

1. **共通パーツ**:

- `ResourceHeader.tsx`: Gold 等の表示。
- `BackButton.tsx`: キャンプへ戻るボタン。

2. **`Guild.tsx`**:

- タブ切り替えステート (`activeTab`)。
- リストレンダリング (`rumors.map`, `quests.map`)。

3. **`Shop.tsx`**:

- `ShopItem` コンポーネント作成。
- 購入ハンドラ: `resources.gold >= item.price` チェック → リソース減算 → インベントリ追加。

4. **`Blacksmith.tsx`**:

- 装備選択状態 (`selectedEquipmentId`)。
- `EQUIPMENT_AND_ITEMS_DESIGN.md` のロジックに基づくコスト計算関数 `calculateUpgradeCost(rarity, level)` の実装。

5. **`Temple.tsx`**:

- スキルツリーのデータ構造定義。
- 解放状態の永続化。

6. **`Library.tsx`**:

- 既存のカードコンポーネントを再利用してデッキ表示。

7. **`Warehouse.tsx`**:

- 装備スロット UI の実装。
- 装備変更ハンドラ (`equipItem(slot, itemId)`).

### Step 4: `BaseCamp.tsx` の改修

- 現在の「Coming Soon」表示部分を、作成した各コンポーネントへのルーティング（条件付きレンダリング）に置き換えます。
- 背景画像や BGM の切り替えロジックを追加（あれば）。

### Step 5: 永続化（セーブ/ロード）

- `localStorage` またはバックエンドへの保存処理。
- キャンプを出る（ダンジョンへ出発する）タイミング、および重要なアクション（購入・強化）の後にオートセーブを走らせる。

---

## 4. エンジニアリング・アドバイス & 矛盾点解消

### 設計書の矛盾点・懸念点

1. **魔石の扱い**:

- `EQUIPMENT_AND_ITEMS_DESIGN.md` では「魔石削除済み」という記述と「魔石を消費して強化」という記述が混在している箇所がありましたが、最新の方針（**魔石は存在する**）に合わせて設計しました。
- **解決策**: 魔石は `MagicStones` (極小〜極大) という詳細な種別があるようですが（`return_system.md`）、UI 上は簡略化して「魔石ポイント」として扱うか、インベントリで個別に管理するか決める必要があります。**今回は「魔石（汎用通貨）」として数値を扱う**方向で設計しています。もし「極小魔石」「大魔石」を区別するなら、鍛冶屋の UI で素材選択が必要になります。

2. **訓練場の扱い**:

- `CAMP_FACILITIES_DESIGN.md` で「訓練場は除外」とされていますが、`BaseCamp.tsx` にはまだ `Training` アイコンがあります。
- **解決策**: 実装時に `Training` ボタンを削除、または `Library` (デッキ確認) と統合する形を取ります。

3. **装備データの共有**:

- キャンプで変更した装備が、バトルパート（`BattleScreen`）に正しく渡される必要があります。
- **解決策**: 装備情報は `PlayerContext` のようなグローバルステートに持たせ、バトル開始時にそのステートを参照して初期化するようにします。

### クオリティアップのための質問

1. **魔石の種別**: `return_system.md` にある「極小・小・中・大・極大」の魔石は、**通貨として合算（1 つの数値）しますか？ それともアイテムとして個別に管理**しますか？

- _推奨_: シンプルにするなら、換金用・強化用ポイントとして「魔石パワー」のような 1 つの数値に変換して管理するのが UI 的にスッキリします。

2. **装備のユニーク性**: 同じ名前の装備（例：「戦士の剣」）を複数所持することは可能ですか？

- _推奨_: 可能とすべきです（個体ごとに強化レベルやランダム OP がつく可能性があるため）。その場合、各装備にユニーク ID (`uuid`) が必須です。

---

この設計に基づき、まずは **「型定義」** と **「BaseCamp のコンポーネント分割」** から始めるのが良いでしょう。
具体的なコードの実装に進む場合は、指示をください。
